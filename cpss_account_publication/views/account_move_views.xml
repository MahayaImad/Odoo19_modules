<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue formulaire des factures -->
    <record id="view_move_form_inherit_publication" model="ir.ui.view">
        <field name="name">account.move.form.publication</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Ajouter la barre de statut de publication -->
            <xpath expr="//header" position="inside">
                <field name="can_toggle_publication" invisible="1"/>
                <button name="action_publish"
                        string="Publier"
                        type="object"
                        class="oe_highlight"
                        invisible="publication_state == 'published' or not can_toggle_publication"
                        groups="account.group_account_manager"/>
                <button name="action_unpublish"
                        string="Dépublier"
                        type="object"
                        invisible="publication_state == 'not_published' or not can_toggle_publication"
                        groups="account.group_account_manager"/>
            </xpath>

            <!-- Ajouter le champ statusbar après le champ state -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="publication_state"
                       widget="statusbar"
                       statusbar_visible="not_published,published"/>
            </xpath>

            <!-- Ajouter les informations de publication dans l'onglet "Autres informations" -->
            <xpath expr="//page[@name='other_info']//group[@name='misc_group']" position="inside">
                <group string="Publication" name="publication_group">
                    <field name="publication_number"
                           readonly="1"
                           invisible="publication_state == 'not_published'"/>
                    <field name="publication_date"
                           readonly="1"
                           invisible="publication_state == 'not_published'"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Vue liste des factures -->
    <record id="view_invoice_tree_inherit_publication" model="ir.ui.view">
        <field name="name">account.move.tree.publication</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_tree"/>
        <field name="arch" type="xml">
            <!-- Ajouter la colonne état de publication -->
            <xpath expr="//field[@name='move_type']" position="after">
                <field name="publication_state"
                       widget="badge"
                       decoration-success="publication_state == 'published'"
                       decoration-info="publication_state == 'not_published'"
                       optional="show"/>
                <field name="publication_number" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Vue liste des factures clients -->
    <record id="view_out_invoice_tree_inherit_publication" model="ir.ui.view">
        <field name="name">account.invoice.tree.publication</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_out_invoice_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='move_type']" position="after">
                <field name="publication_state"
                       widget="badge"
                       decoration-success="publication_state == 'published'"
                       decoration-info="publication_state == 'not_published'"
                       optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Vue recherche -->
    <record id="view_account_invoice_filter_inherit_publication" model="ir.ui.view">
        <field name="name">account.invoice.search.publication</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <!-- Ajouter des filtres pour l'état de publication -->
            <xpath expr="//filter[@name='late']" position="after">
                <separator/>
                <filter name="published"
                        string="Publiées"
                        domain="[('publication_state', '=', 'published')]"/>
                <filter name="not_published"
                        string="Non publiées"
                        domain="[('publication_state', '=', 'not_published')]"/>
            </xpath>

            <!-- Ajouter un regroupement par état de publication -->
            <xpath expr="//group" position="inside">
                <filter name="group_by_publication_state"
                        string="État de publication"
                        context="{'group_by': 'publication_state'}"/>
            </xpath>

            <!-- Ajouter le champ dans la recherche -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="publication_number"/>
            </xpath>
        </field>
    </record>

    <!-- Vue kanban (optionnel) -->
    <record id="view_account_move_kanban_inherit_publication" model="ir.ui.view">
        <field name="name">account.move.kanban.publication</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_move_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//templates" position="before">
                <field name="publication_state"/>
                <field name="publication_number"/>
            </xpath>
            <xpath expr="//field[hasclass('ms-auto')]" position="after">
                <span t-if="record.publication_state.raw_value == 'published'"
                      class="badge badge-success">
                    <i class="fa fa-check"/> Publié
                </span>
            </xpath>
        </field>
    </record>
</odoo>